<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fabric Minecraft Server - Sysadmin Manual</title>
    <link rel="stylesheet" href="../../index.css">
    <style>
        h2 { color: #7aa2f7; margin-top: 30px; border-bottom: 1px solid #414868; padding-bottom: 10px; }
        h3 { color: #7aa2f7; margin-top: 25px; }
        .warning {
            background: #2d2d1f;
            border-left: 5px solid #ff9e64;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .note {
            background: #24283b;
            border-left: 5px solid #7aa2f7;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        pre {
            background-color: #1f2335;
            border: 1px solid #414868;
            border-radius: 5px;
            padding: 15px;
            overflow-x: auto;
            font-family: "Courier New", Courier, monospace;
            font-size: 0.95em;
            color: #9ece6a;
        }
        li { margin-bottom: 10px; }
    </style>
</head>
<body>

    <p style="margin-bottom: 20px;"><a href="../">← Back to Minecraft Documentation</a> | <a href="../../">Documentation Portal</a></p>

    <h1>Fabric Minecraft Server - Sysadmin Setup Manual</h1>
    <p>This document outlines the complete procedure to construct the Minecraft Java Edition (Fabric) server infrastructure from a bare-metal Linux installation. This configuration emphasizes stability, security via network segmentation (Tailscale), and automated offsite backups.</p>

    <div class="note">
        <strong>Scope of Document:</strong> This manual covers only the Minecraft server backend, system services, security, and backup infrastructure. Web server configurations are excluded.
    </div>

    <h2>1. Environment Prerequisites & Setup</h2>

    <h3>1.1 System Requirements</h3>
    <ul>
        <li><strong>OS:</strong> Ubuntu 22.04 LTS (or similar Debian-based distribution).</li>
        <li><strong>RAM:</strong> Minimum 6GB dedicated to the OS (allocating 4GB+ to Java).</li>
        <li><strong>Access:</strong> Root or sudo privileges for initial setup.</li>
    </ul>

    <h3>1.2 Install Dependencies</h3>
    <p>Update package lists and install necessary tools: OpenJDK 21 (Headless), Screen (for background console management), UFW (firewall), Zip/Unzip, Curl, and Rclone (for backups).</p>
    <pre>sudo apt update && sudo apt upgrade -y
sudo apt install openjdk-21-jre-headless screen ufw zip unzip curl -y
sudo curl https://rclone.org/install.sh | sudo bash</pre>

    <h3>1.3 Create Dedicated Service User</h3>
    <p>For security, the server should never run as root. Create a dedicated user (e.g., <code>mcserver</code>).</p>
    <pre>sudo adduser mcserver
# Follow prompts to set a strong password.</pre>

    <div class="warning">
        <strong>Crucial:</strong> All subsequent steps related to game files should be performed as this dedicated user, not root.
    </div>
    <p>Switch to the user:</p>
    <pre>su - mcserver</pre>


    <h2>2. Network Security & Tailscale Setup</h2>

    <h3>2.1 Configure System Firewall (UFW)</h3>
    <p>Implement a "Default Deny" policy. Only allow standard Minecraft traffic directly from the public internet. SSH access should be restricted to the local LAN or Tailscale network interfaces.</p>
    <pre># Ensure you are logged in as a sudo user for these commands
sudo ufw default deny incoming
sudo ufw default allow outgoing

# Allow public Minecraft traffic (Default TCP 25565)
sudo ufw allow 25565/tcp

# Enable firewall
sudo ufw enable</pre>

    <h3>2.2 Install Tailscale (Secure Admin Access)</h3>
    <p>Install Tailscale so the server joins your private administrative network. This allows you to SSH into the server without exposing Port 22 to the public internet.</p>
    <pre>curl -fsSL https://tailscale.com/install.sh | sh
sudo tailscale up
# Follow the link provided to authenticate the machine.</pre>

    <h3>2.3 Trust Tailscale Interface</h3>
    <p>Tell UFW to allow all traffic coming from other devices on your Tailscale network.</p>
    <pre>sudo ufw allow in on tailscale0</pre>

    <h3>2.4 External Port Forwarding</h3>
    <p>Log into the network edge router. Forward TCP Port <strong>25565</strong> to the server's local LAN IP address.</p>


    <h2>3. Server Installation (Fabric)</h2>

    <h3>3.1 Directory Structure</h3>
    <p>Ensure you are logged in as the dedicated user (<code>mcserver</code>). Create the directory structure.</p>
    <pre>mkdir -p ~/fabric_server
cd ~/fabric_server</pre>

    <h3>3.2 Download Fabric Installer</h3>
    <p>Visit <a href="https://fabricmc.net/use/server/" target="_blank">fabricmc.net</a> to grab the latest installer URL or use curl. (Example below uses a generic name, check site for actual current version).</p>
    <pre>curl -OJ https://maven.fabricmc.net/net/fabricmc/fabric-installer/1.0.0/fabric-installer-1.0.0.jar</pre>

    <h3>3.3 Execute Installer & Download Minecraft Jar</h3>
    <p>Run the installer jar to download the vanilla Minecraft server jar and generate the necessary Fabric libraries.</p>
    <pre># Replace installer jar name with actual downloaded version
java -jar fabric-installer-*.jar server -downloadMinecraft</pre>
    <p><em>Note: You may delete the installer jar after this step.</em></p>

    <h3>3.4 Accept EULA</h3>
    <p>Attempt to run the server once to generate the EULA file, then accept it.</p>
    <pre>java -Xmx2G -jar fabric-server-launch.jar nogui
# It will exit immediately.
sed -i 's/eula=false/eula=true/g' eula.txt</pre>


    <h2>4. Configuration & Launch Scripts</h2>

    <h3>4.1 Server Properties</h3>
    <p>Edit `server.properties` to configure game settings.</p>
    <pre>nano server.properties</pre>
    <p>Key requirements:</p>
    <ul>
        <li><code>server-port=25565</code></li>
        <li><code>white-list=true</code> (Highly recommended for private servers)</li>
    </ul>

    <h3>4.2 Create Startup Script (start.sh)</h3>
    <p>Create a script to handle Java arguments and launch the server inside a detached <code>screen</code> session. This is crucial for systemd integration.</p>
    <pre>nano ~/fabric_server/start.sh</pre>
    <p><strong>File Content:</strong></p>
    <pre>#!/bin/bash
# Minecraft Server Startup Script
SERVER_DIR=/home/mcserver/fabric_server
JAR_NAME=fabric-server-launch.jar

# RAM Allocation (adjust based on available system RAM)
RAM=4G

cd "$SERVER_DIR"
# -DmS starts a detached screen session named 'mcserver'
/usr/bin/screen -DmS mcserver /usr/bin/java -Xmx$RAM -Xms$RAM -jar $JAR_NAME nogui</pre>
    <p>Make the script executable:</p>
    <pre>chmod +x ~/fabric_server/start.sh</pre>


    <h2>5. Systemd Service Integration (Auto-Start)</h2>

    <p>Create a systemd unit file to manage the server as a native Linux service. This handles auto-start on boot and graceful shutdowns.</p>

    <h3>5.1 Create Unit File</h3>
    <p>As a sudo user:</p>
    <pre>sudo nano /etc/systemd/system/minecraft.service</pre>
    <p><strong>File Content:</strong> (Ensure paths and User match your setup)</p>
    <pre>[Unit]
Description=Fabric Minecraft Server
After=network.target

[Service]
# The user created in Step 1.3
User=mcserver
Group=mcserver
WorkingDirectory=/home/mcserver/fabric_server

# Start Command uses the script created in Step 4.2
ExecStart=/home/mcserver/fabric_server/start.sh

# Stop Command sends the "stop" command into the running screen session
ExecStop=/usr/bin/screen -p 0 -S mcserver -X eval 'stuff "stop"\015'

# Restart policy
Restart=on-failure
RestartSec=10s

[Install]
WantedBy=multi-user.target</pre>

    <h3>5.2 Enable and Start Service</h3>
    <pre>sudo systemctl daemon-reload
sudo systemctl enable minecraft
sudo systemctl start minecraft</pre>
    <p>Verify status:</p>
    <pre>sudo systemctl status minecraft</pre>


    <h2>6. Usage & Maintenance</h2>

    <h3>6.1 Accessing the Server Console</h3>
    <p>To view logs or issue commands, attach to the running screen session as the service user.</p>
    <pre># Switch to service user if needed
su - mcserver

# Attach to session
screen -r mcserver</pre>
    <p><strong>To detach (leave running):</strong> Press <code>Ctrl + A</code>, then press <code>D</code>.</p>

    <h3>6.2 Starting/Stopping</h3>
    <p>Use standard systemctl commands (requires sudo privileges):</p>
    <pre>sudo systemctl stop minecraft
sudo systemctl restart minecraft</pre>


    <h2>7. Automated Offsite Backups</h2>

    <p>Backups are handled by a custom script that stops game writes, zips the world data, and uploads it to Google Drive using Rclone.</p>

    <h3>7.1 Configure Rclone Remote</h3>
    <p>Run the configuration wizard to authorize Google Drive access. Name the remote <code>gdrive</code>.</p>
    <pre>rclone config
# Follow prompts: n (new remote) -> name: gdrive -> Storage Number for Drive -> Follow auth steps.</pre>

    <h3>7.2 Create Backup Script</h3>
    <p>As the service user (<code>mcserver</code>), create the automation script.</p>
    <pre>mkdir -p ~/scripts
mkdir -p ~/backups
nano ~/scripts/backup_world.sh</pre>
    <p><strong>File Content:</strong></p>
    <pre>#!/bin/bash
# --- CONFIG ---
SERVER_DIR="/home/mcserver/fabric_server"
WORLD_NAME="world"
BACKUP_DIR="/home/mcserver/backups"
REMOTE_NAME="gdrive"
# Use underscores, avoid colons in remote folder names for cross-OS compatibility
REMOTE_PATH="backups/minecraft_25565"
TIMESTAMP=$(date +"%Y-%m-%d_%H-%M")
ZIP_NAME="world_${TIMESTAMP}.zip"

# --- EXECUTION ---
echo "Starting backup process for $TIMESTAMP..."

# Optional: Send 'save-all' and 'save-off' to console via screen before zipping for perfect data integrity
# /usr/bin/screen -p 0 -S mcserver -X eval 'stuff "save-all"\015'
# sleep 5
# /usr/bin/screen -p 0 -S mcserver -X eval 'stuff "save-off"\015'

# Zip the world folder relative to the server directory
cd "$SERVER_DIR"
zip -r -q "$BACKUP_DIR/$ZIP_NAME" "$WORLD_NAME"

# Optional: Turn game saving back on
# /usr/bin/screen -p 0 -S mcserver -X eval 'stuff "save-on"\015'

echo "Uploading $ZIP_NAME to remote..."
# --min-age ensures file is finished writing before upload attempts
rclone copy "$BACKUP_DIR/$ZIP_NAME" "$REMOTE_NAME:$REMOTE_PATH" --min-age 1s -P

# Cleanup local zip to save space
rm "$BACKUP_DIR/$ZIP_NAME"

echo "Backup complete."</pre>
    <p>Make executable:</p>
    <pre>chmod +x ~/scripts/backup_world.sh</pre>

    <h3>7.3 Automate with Cron</h3>
    <p>Open the crontab for the service user:</p>
    <pre>crontab -e</pre>
    <p>Add the following line to run the backup daily at 4:00 AM:</p>
    <pre>0 4 * * * /home/mcserver/scripts/backup_world.sh >> /home/mcserver/scripts/backup.log 2>&1</pre>

    <p style="margin-top: 40px; font-size: 0.9em; color: #414868; text-align: center;">
        <a href="../">← Back to Minecraft Documentation</a>
    </p>

</body>
</html>
